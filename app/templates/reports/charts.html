{% extends 'layout.html' %}
{% block title %}Charts & Analytics - Inventory Management{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">📈 Inventory Charts & Analytics</h1>
  <div class="page-actions">
    <a href="/reports/balance" class="btn btn-primary">📊 Balance Report</a>
    <a href="/movements/create" class="btn btn-success">📦 Record Movement</a>
    <button onclick="refreshCharts()" class="btn btn-secondary">🔄 Refresh Data</button>
    <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="btn btn-info">🔄 Auto Refresh: OFF</button>
  </div>
</div>

<div class="charts-container">
  <!-- Stock Status Overview -->
  <div class="chart-card">
    <div class="chart-header">
      <h3>📋 Stock Status Overview</h3>
      <span class="chart-subtitle">Distribution of inventory status</span>
    </div>
    <div class="chart-content">
      <canvas id="stockStatusChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Inventory by Product -->
  <div class="chart-card">
    <div class="chart-header">
      <h3>📦 Inventory by Product</h3>
      <span class="chart-subtitle">Total stock per product</span>
    </div>
    <div class="chart-content">
      <canvas id="productChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Inventory by Location -->
  <div class="chart-card">
    <div class="chart-header">
      <h3>🏪 Inventory by Location</h3>
      <span class="chart-subtitle">Stock distribution across warehouses</span>
    </div>
    <div class="chart-content">
      <canvas id="locationChart" width="400" height="200"></canvas>
    </div>
  </div>

  <!-- Movement Trends -->
  <div class="chart-card chart-wide">
    <div class="chart-header">
      <h3>📈 Movement Trends (Last 30 Days)</h3>
      <span class="chart-subtitle">Daily inventory movement activity</span>
    </div>
    <div class="chart-content">
      <canvas id="trendsChart" width="800" height="300"></canvas>
    </div>
  </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart data from server
const chartData = {{ chart_data | safe }};

// Color palettes
const colors = {
  primary: ['#007bff', '#0056b3', '#004085'],
  success: ['#28a745', '#1e7e34', '#155724'],
  warning: ['#ffc107', '#e0a800', '#d39e00'],
  danger: ['#dc3545', '#c82333', '#bd2130'],
  info: ['#17a2b8', '#138496', '#117a8b'],
  mixed: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#e83e8c', '#fd7e14']
};

// Stock Status Pie Chart
const stockStatusCtx = document.getElementById('stockStatusChart').getContext('2d');
new Chart(stockStatusCtx, {
  type: 'doughnut',
  data: {
    labels: chartData.stock_status_labels,
    datasets: [{
      data: chartData.stock_status_data,
      backgroundColor: [colors.success[0], colors.warning[0], colors.danger[0]],
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 20,
          usePointStyle: true
        }
      }
    }
  }
});

// Product Bar Chart
const productCtx = document.getElementById('productChart').getContext('2d');
new Chart(productCtx, {
  type: 'bar',
  data: {
    labels: chartData.product_labels,
    datasets: [{
      label: 'Stock Quantity',
      data: chartData.product_data,
      backgroundColor: colors.primary[0],
      borderColor: colors.primary[1],
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Quantity'
        }
      },
      x: {
        title: {
          display: true,
          text: 'Products'
        }
      }
    },
    plugins: {
      legend: {
        display: false
      }
    }
  }
});

// Location Pie Chart
const locationCtx = document.getElementById('locationChart').getContext('2d');
new Chart(locationCtx, {
  type: 'pie',
  data: {
    labels: chartData.location_labels,
    datasets: [{
      data: chartData.location_data,
      backgroundColor: colors.mixed.slice(0, chartData.location_labels.length),
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 20,
          usePointStyle: true
        }
      }
    }
  }
});

// Movement Trends Line Chart
const trendsCtx = document.getElementById('trendsChart').getContext('2d');
new Chart(trendsCtx, {
  type: 'line',
  data: {
    labels: chartData.movement_trends.dates,
    datasets: [{
      label: 'Movement Count',
      data: chartData.movement_trends.movement_counts,
      borderColor: colors.info[0],
      backgroundColor: colors.info[0] + '20',
      tension: 0.4,
      fill: true,
      yAxisID: 'y'
    }, {
      label: 'Total Quantity',
      data: chartData.movement_trends.total_quantities,
      borderColor: colors.success[0],
      backgroundColor: colors.success[0] + '20',
      tension: 0.4,
      fill: false,
      yAxisID: 'y1'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    interaction: {
      mode: 'index',
      intersect: false,
    },
    scales: {
      x: {
        title: {
          display: true,
          text: 'Date'
        }
      },
      y: {
        type: 'linear',
        display: true,
        position: 'left',
        title: {
          display: true,
          text: 'Movement Count'
        }
      },
      y1: {
        type: 'linear',
        display: true,
        position: 'right',
        title: {
          display: true,
          text: 'Total Quantity'
        },
        grid: {
          drawOnChartArea: false,
        },
      }
    },
    plugins: {
      legend: {
        position: 'top',
      }
    }
  }
});

// Refresh charts function
function refreshCharts() {
  fetch('/reports/api/chart-data')
    .then(response => response.json())
    .then(data => {
      // Update all charts with new data
      location.reload(); // Simple refresh for now
    })
    .catch(error => {
      console.error('Error refreshing charts:', error);
    });
}

// Auto-refresh functionality
let autoRefreshInterval = null;
let isAutoRefreshOn = false;

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (isAutoRefreshOn) {
        // Turn off auto-refresh
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        isAutoRefreshOn = false;
        btn.textContent = '🔄 Auto Refresh: OFF';
        btn.className = 'btn btn-info';
    } else {
        // Turn on auto-refresh (every 45 seconds for charts)
        autoRefreshInterval = setInterval(() => {
            refreshCharts();
        }, 45000);
        isAutoRefreshOn = true;
        btn.textContent = '🔄 Auto Refresh: ON (45s)';
        btn.className = 'btn btn-success';
    }
}
</script>

<style>
.charts-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 2rem;
  margin-top: 2rem;
}

.chart-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  padding: 1.5rem;
  border: 1px solid #e9ecef;
}

.chart-wide {
  grid-column: 1 / -1;
}

.chart-header {
  margin-bottom: 1.5rem;
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 1rem;
}

.chart-header h3 {
  margin: 0;
  color: #2c3e50;
  font-size: 1.25rem;
  font-weight: 600;
}

.chart-subtitle {
  color: #6c757d;
  font-size: 0.9rem;
  margin-top: 0.25rem;
  display: block;
}

.chart-content {
  position: relative;
  height: 300px;
}

.chart-wide .chart-content {
  height: 400px;
}

@media (max-width: 768px) {
  .charts-container {
    grid-template-columns: 1fr;
  }
  
  .chart-content {
    height: 250px;
  }
  
  .chart-wide .chart-content {
    height: 300px;
  }
}
</style>
{% endblock %}
