{% extends 'layout.html' %}
{% block title %}Balance Report - Inventory Management{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">📊 Inventory Balance Report</h1>
  <div class="page-actions">
    <a href="/reports/charts" class="btn btn-primary">📈 View Charts</a>
    <a href="/movements/create" class="btn btn-success">📦 Record Movement</a>
    <button onclick="window.print()" class="btn btn-secondary">🖨️ Print Report</button>
    <button id="autoRefreshBtn" onclick="toggleAutoRefresh()" class="btn btn-info">🔄 Auto Refresh: OFF</button>
  </div>
</div>

{% if rows %}
<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-number">{{ rows|map(attribute='product')|unique|list|length }}</div>
    <div class="stat-label">Products Tracked</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ rows|map(attribute='location')|unique|list|length }}</div>
    <div class="stat-label">Active Locations</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ rows|length }}</div>
    <div class="stat-label">Inventory Records</div>
  </div>
  <div class="stat-card">
    <div class="stat-number">{{ rows|sum(attribute='qty') }}</div>
    <div class="stat-label">Total Units</div>
  </div>
</div>

<!-- Quick Charts Section -->
<div class="quick-charts">
  <div class="chart-card">
    <div class="chart-header">
      <h3>📦 Stock by Product</h3>
    </div>
    <div class="chart-content">
      <canvas id="quickProductChart" width="400" height="200"></canvas>
    </div>
  </div>
  
  <div class="chart-card">
    <div class="chart-header">
      <h3>🏪 Stock by Location</h3>
    </div>
    <div class="chart-content">
      <canvas id="quickLocationChart" width="400" height="200"></canvas>
    </div>
  </div>
</div>

<div class="table-container">
  <div class="table-header">
    <h3 class="table-title">Current Stock Levels</h3>
    <span style="color: #6c757d; font-size: 0.9rem;">Real-time inventory balance</span>
  </div>
  <table class="table">
    <thead>
      <tr>
        <th>🏷️ Product</th>
        <th>🏪 Warehouse Location</th>
        <th>📦 Current Stock</th>
        <th>📈 Status</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td><strong>{{ r.product }}</strong></td>
        <td>{{ r.location }}</td>
        <td><strong style="font-size: 1.1rem;">{{ r.qty }}</strong> units</td>
        <td>
          {% if r.qty > 10 %}
            <span class="status-badge status-good">✅ Well Stocked</span>
          {% elif r.qty > 0 %}
            <span class="status-badge status-low">⚠️ Low Stock</span>
          {% else %}
            <span class="status-badge status-empty">❌ Out of Stock</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="info-box">
  <h4>📋 Report Summary</h4>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
    <div>
      <strong>Well Stocked:</strong> {{ rows|selectattr('qty', '>', 10)|list|length }} items
    </div>
    <div>
      <strong>Low Stock:</strong> {{ rows|selectattr('qty', '<=', 10)|selectattr('qty', '>', 0)|list|length }} items  
    </div>
    <div>
      <strong>Out of Stock:</strong> {{ rows|selectattr('qty', '<=', 0)|list|length }} items
    </div>
    <div>
      <strong>Report Generated:</strong> Just now
    </div>
  </div>
</div>

{% else %}
<div class="table-container">
  <div class="empty-state">
    <div class="empty-state-icon">📊</div>
    <h3>No Inventory Data Available</h3>
    <p>No product movements have been recorded yet. Start by adding products and recording some inventory movements.</p>
    <div style="margin-top: 1.5rem;">
      <a href="/products/create" class="btn btn-primary">📋 Add Products</a>
      <a href="/movements/create" class="btn btn-success">📦 Record Movement</a>
    </div>
  </div>
</div>
{% endif %}

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
{% if rows %}
// Chart data
const chartData = {{ chart_data | tojson }};

// Colors
const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6610f2', '#e83e8c', '#fd7e14'];

// Quick Product Chart
const productCtx = document.getElementById('quickProductChart').getContext('2d');
new Chart(productCtx, {
  type: 'bar',
  data: {
    labels: chartData.product_labels,
    datasets: [{
      label: 'Stock Quantity',
      data: chartData.product_data,
      backgroundColor: colors[0],
      borderColor: colors[0],
      borderWidth: 1
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: {
        beginAtZero: true,
        title: {
          display: true,
          text: 'Quantity'
        }
      }
    },
    plugins: {
      legend: {
        display: false
      }
    }
  }
});

// Quick Location Chart
const locationCtx = document.getElementById('quickLocationChart').getContext('2d');
new Chart(locationCtx, {
  type: 'doughnut',
  data: {
    labels: chartData.location_labels,
    datasets: [{
      data: chartData.location_data,
      backgroundColor: colors.slice(0, chartData.location_labels.length),
      borderWidth: 2,
      borderColor: '#fff'
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          padding: 15,
          usePointStyle: true
        }
      }
    }
  }
});
{% endif %}

// Auto-refresh functionality
let autoRefreshInterval = null;
let isAutoRefreshOn = false;

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    
    if (isAutoRefreshOn) {
        // Turn off auto-refresh
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        isAutoRefreshOn = false;
        btn.textContent = '🔄 Auto Refresh: OFF';
        btn.className = 'btn btn-info';
    } else {
        // Turn on auto-refresh (every 30 seconds)
        autoRefreshInterval = setInterval(() => {
            location.reload();
        }, 30000);
        isAutoRefreshOn = true;
        btn.textContent = '🔄 Auto Refresh: ON (30s)';
        btn.className = 'btn btn-success';
    }
}

// Auto-trigger stock info updates
document.addEventListener('DOMContentLoaded', function() {
    // If there's chart data, update the stock info automatically
    {% if rows %}
    updateStockInfo();
    {% endif %}
});

function updateStockInfo() {
    // Add any dynamic stock information updates here
    console.log('Stock information updated');
    
    // Example: Add tooltips or additional info to stock items
    const stockRows = document.querySelectorAll('tbody tr');
    stockRows.forEach(row => {
        const qtyCell = row.querySelector('td:nth-child(3)');
        if (qtyCell) {
            const qty = parseInt(qtyCell.textContent.match(/\d+/)[0]);
            if (qty <= 5) {
                qtyCell.style.color = '#dc3545';
                qtyCell.style.fontWeight = 'bold';
            } else if (qty <= 10) {
                qtyCell.style.color = '#ffc107';
                qtyCell.style.fontWeight = 'bold';
            }
        }
    });
}
</script>

<style>
.quick-charts {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: 2rem;
  margin: 2rem 0;
}

.chart-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  padding: 1.5rem;
  border: 1px solid #e9ecef;
}

.chart-header {
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #e9ecef;
}

.chart-header h3 {
  margin: 0;
  color: #2c3e50;
  font-size: 1.1rem;
  font-weight: 600;
}

.chart-content {
  position: relative;
  height: 250px;
}

@media (max-width: 768px) {
  .quick-charts {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}
